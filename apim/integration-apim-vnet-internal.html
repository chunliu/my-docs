<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Connect APIM to internal VNET - Azure Scrolls</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../toc.html">TOC</a></li><li class="chapter-item expanded "><a href="../apim/integration-overview.html"><strong aria-hidden="true">1.</strong> Tutorials - Integrate App Gateway, APIM and Self-Hosted Gateway</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../apim/integration-prepare-environment.html"><strong aria-hidden="true">1.1.</strong> Prepare the VNET environment</a></li><li class="chapter-item expanded "><a href="../apim/integration-apim-vnet-internal.html" class="active"><strong aria-hidden="true">1.2.</strong> Connect APIM to internal VNET</a></li><li class="chapter-item expanded "><a href="../apim/integration-appgw-apim.html"><strong aria-hidden="true">1.3.</strong> Integrate APIM with AppGW</a></li><li class="chapter-item expanded "><a href="../apim/integration-deploy-shgw.html"><strong aria-hidden="true">1.4.</strong> Deploy self-hosted gateway</a></li><li class="chapter-item expanded "><a href="../apim/integration-appgw-shgw.html"><strong aria-hidden="true">1.5.</strong> Integrate AppGW with self-hosted gateway</a></li><li class="chapter-item expanded "><a href="../apim/integration-verification.html"><strong aria-hidden="true">1.6.</strong> Verify the deployment</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Azure Scrolls</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#connect-api-management-to-virtual-network-in-internal-mode" id="connect-api-management-to-virtual-network-in-internal-mode">Connect API Management to virtual network in Internal mode</a></h1>
<p>In the previous tutorial, you created the virtual network, the private DNS zone and the API Management instance. In this tutorial, we continue connecting the API Management instance to the virtual network in Internal mode.</p>
<p>In this tutorial, you learn to:</p>
<ul>
<li>✅ Connect the APIM instance in the virtual network in Internal mode</li>
<li>✅ Create custom domain names in the private DNS zone</li>
<li>✅ Create self-signed certificates with PowerShell script</li>
<li>✅ Configure the APIM instance with custom domain names</li>
</ul>
<h2><a class="header" href="#connect-apim-instance-to-the-vnet-in-internal-mode" id="connect-apim-instance-to-the-vnet-in-internal-mode">Connect APIM instance to the VNET in Internal mode</a></h2>
<ol>
<li>
<p>In Azure Portal, open the APIM instance you created in the previous tutorial.</p>
</li>
<li>
<p>Click <strong>Virtual network</strong> under <strong>Deployment and infrastructure</strong> to open the VNET integration page.</p>
</li>
<li>
<p>Choose <strong>Internal</strong> for <strong>Virtual network</strong> and click the VNET option below to choose the VNET and the subnet.</p>
</li>
<li>
<p>Choose <strong>apim-vnet</strong> for the virtual network and <strong>apim-subnet</strong> for the subnet. Click <strong>Apply</strong>.</p>
<p><img src="images/apim-internal-vnet.png" alt="apim internal vnet" /></p>
</li>
<li>
<p>Click <strong>Save</strong> to apply the changes. The changes could take 15 to 45 minutes to be applied.</p>
</li>
<li>
<p>When the APIM instance is deployed in the VNET successfully, you can find the <strong>private</strong> and <strong>public</strong> virtual IP addresses for the APIM instance on the <strong>Overview</strong> page. Take a note for the private IP address. We need to use it later.</p>
<p><img src="images/apim-private-ip.png" alt="private IP address" /></p>
</li>
</ol>
<p>For more information about the impact of the VNET Internal mode, please see <a href="https://docs.microsoft.com/azure/api-management/api-management-using-with-internal-vnet">this document</a>.</p>
<h2><a class="header" href="#create-custom-domain-names" id="create-custom-domain-names">Create custom domain names</a></h2>
<p>With VNET Internal mode, we need to configure the APIM instance with custom domain names before we can access its service endpoints. In our scenarios, we need at least 2 domain names, one for the <strong>Gateway</strong> and the other for the <strong>Management</strong>.</p>
<ol>
<li>In Azure Portal, open the private DNS zone <strong>contoso.net</strong>.</li>
<li>Click <strong>Record set</strong> to add a new record set.</li>
<li>Create the record set with <strong>Name</strong>: <code>apim-gw</code> and <strong>IP address</strong>: <code>172.17.0.5</code>.
<img src="images/private-zone-recordset.png" alt="record set" /></li>
<li>Repeat the steps to create another record set with <strong>Name</strong>: <code>apim-mgmt</code> and <strong>IP address</strong>: <code>172.17.0.5</code>.</li>
</ol>
<h2><a class="header" href="#create-self-signed-certificates-for-ssl" id="create-self-signed-certificates-for-ssl">Create self-signed certificates for SSL</a></h2>
<p>We also need certificates for SSL bindings of APIM. In the production environment, you should use the certificates that are trusted by your organization. We use self-signed certificates in these tutorials just for demo purpose.</p>
<p>To make things easier, we create 2 certificates with the following PowerShell script. One of the certificates is a root certificate for signing, and the other is a wildcard certificate for SSL bindings of the custom domain names.</p>
<pre><code class="language-PowerShell"># Create the root signing cert
$root = New-SelfSignedCertificate -Type Custom -KeySpec Signature `
    -Subject &quot;CN=contoso-net-signing-root&quot; -KeyExportPolicy Exportable `
    -HashAlgorithm sha256 -KeyLength 4096 `
    -CertStoreLocation &quot;Cert:\CurrentUser\My&quot; -KeyUsageProperty Sign `
    -KeyUsage CertSign -NotAfter (get-date).AddYears(5)
# Create the wildcard SSL cert.
$ssl = New-SelfSignedCertificate -Type Custom -DnsName &quot;*.contoso.net&quot;,&quot;contoso.net&quot; `
    -KeySpec Signature `
    -Subject &quot;CN=*.contoso.net&quot; -KeyExportPolicy Exportable `
    -HashAlgorithm sha256 -KeyLength 2048 `
    -CertStoreLocation &quot;Cert:\CurrentUser\My&quot; `
    -Signer $root
# Export CER of the root and SSL certs
Export-Certificate -Type CERT -Cert $root -FilePath .\contoso-signing-root.cer
Export-Certificate -Type CERT -Cert $ssl -FilePath .\contoso-ssl.cer
# Export PFX of the root and SSL certs
Export-PfxCertificate -Cert $root -FilePath .\contoso-signing-root.pfx `
    -Password (read-host -AsSecureString -Prompt &quot;password&quot;)
Export-PfxCertificate -Cert $ssl -FilePath .\contoso-ssl.pfx `
    -ChainOption BuildChain -Password (read-host -AsSecureString -Prompt &quot;password&quot;)
</code></pre>
<p>With the above script, you get the following 4 files.</p>
<ul>
<li>contoso-signing-root.cer</li>
<li>contoso-signing-root.pfx</li>
<li>contoso-ssl.cer</li>
<li>contoso-ssl.pfx</li>
</ul>
<p>Please note down the passwords you use for the PFX files. We need to use them later.</p>
<h2><a class="header" href="#configure-custom-domain-names-for-the-apim-instance" id="configure-custom-domain-names-for-the-apim-instance">Configure custom domain names for the APIM instance</a></h2>
<p>In the production environment, Azure Key Vault is recommended to manage the certificates. We use the <strong>Custom</strong> option in this tutorial. For more information about configuring custom domain, please see <a href="https://docs.microsoft.com/azure/api-management/configure-custom-domain">this document</a>.</p>
<ol>
<li>
<p>In the Azure Portal, go to the APIM instance.</p>
</li>
<li>
<p>Click <strong>Custom domains</strong> and click <strong>Add</strong>.</p>
</li>
<li>
<p>Configure the custom domain for the <strong>Gateway</strong> and <strong>Management</strong> with the following values.</p>
<p><img src="images/apim-custom-domain.png" alt="custom domain" /></p>
</li>
</ol>
<table><thead><tr><th>Type</th><th>Hostname</th><th>Certificate file</th><th>Password</th><th>Default SSL binding</th></tr></thead><tbody>
<tr><td>Gateway</td><td>apim-gw.contoso.net</td><td>contoso-ssl.pfx</td><td><em>password of contoso-ssl.pfx</em></td><td>True</td></tr>
<tr><td>Management</td><td>apim-mgmt.contoso.net</td><td>contoso-ssl.pfx</td><td><em>password of contoso-ssl.pfx</em></td><td>True</td></tr>
</tbody></table>
<ol start="4">
<li>Click <strong>Save</strong> to apply the changes.</li>
</ol>
<p>The APIM instance is connected to the VNET in the Internal mode. You can move on to the next tutorial.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../apim/integration-prepare-environment.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../apim/integration-appgw-apim.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../apim/integration-prepare-environment.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../apim/integration-appgw-apim.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
