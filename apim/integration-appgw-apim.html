<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Integrate APIM with AppGW - Azure Scrolls</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Azure related posts">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../About.html">About</a></li><li class="chapter-item expanded "><a href="../apim/integration-overview.html"><strong aria-hidden="true">1.</strong> Tutorials - Integrate App Gateway, APIM and Self-Hosted Gateway</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../apim/integration-prepare-environment.html"><strong aria-hidden="true">1.1.</strong> Prepare the VNET environment</a></li><li class="chapter-item "><a href="../apim/integration-apim-vnet-internal.html"><strong aria-hidden="true">1.2.</strong> Connect APIM to internal VNET</a></li><li class="chapter-item expanded "><a href="../apim/integration-appgw-apim.html" class="active"><strong aria-hidden="true">1.3.</strong> Integrate APIM with AppGW</a></li><li class="chapter-item "><a href="../apim/integration-deploy-shgw.html"><strong aria-hidden="true">1.4.</strong> Deploy self-hosted gateway</a></li><li class="chapter-item "><a href="../apim/integration-appgw-shgw.html"><strong aria-hidden="true">1.5.</strong> Integrate AppGW with self-hosted gateway</a></li><li class="chapter-item "><a href="../apim/integration-verification.html"><strong aria-hidden="true">1.6.</strong> Verify the deployment</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Azure Scrolls</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/chunliu/my-docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#integrate-the-apim-instance-with-application-gateway" id="integrate-the-apim-instance-with-application-gateway">Integrate the APIM instance with Application Gateway</a></h1>
<p>In the last tutorial, you connected the APIM instance to the VNET in Internal mode and configured the custom domain names for it. In this tutorial, we continue integrating the APIM instance with an Application Gateway.</p>
<p>In this tutorial, you learn to:</p>
<ul>
<li>✅ Create Application Gateway</li>
<li>✅ Create the custom healthy probe for APIM</li>
<li>✅ Verify the integration</li>
</ul>
<h2><a class="header" href="#create-application-gateway" id="create-application-gateway">Create Application Gateway</a></h2>
<ol>
<li>
<p>In the Azure Portal, add a new resource by clicking <strong>Create a resource</strong> link.</p>
</li>
<li>
<p>Search and create <code>Application Gateway</code>.</p>
</li>
<li>
<p>Choose resource group <code>apim-rg</code>, region <code>East US</code>, and give it a name such as <code>apim-appgw</code>.</p>
</li>
<li>
<p>Choose VNET <code>apim-vnet</code> and subnet <code>appgw-subnet</code>. Click <strong>Next: Frontends</strong> button.</p>
</li>
<li>
<p>Choose <code>Public</code> for the frontend IP and create a new public IP address. And then click <strong>Next: backend</strong> button.</p>
</li>
<li>
<p>Add a backend pool as shown in the following diagram.</p>
<p><img src="images/appgw-backend-pool.png" alt="AppGW backend pool" /></p>
</li>
<li>
<p>Move to <strong>Configuration</strong> and add a routing rule. The <strong>Listener</strong> of the routing rule is shown below.</p>
<p><img src="images/appgw-listener.png" alt="AppGW routing rule" /></p>
</li>
<li>
<p>Choose <strong>apim-backend</strong> as the <strong>Backend target</strong>, and add a new <strong>HTTP settings</strong> as shown below. Note that <code>contoso-signing-root.cer</code> is used for <strong>CER certificate</strong> and <strong>Host name override</strong> is set to pick the name from backend.</p>
<p><img src="images/appgw-http-settings.png" alt="AppGW http settings" /></p>
</li>
<li>
<p>Move to <strong>Tags</strong> and add tags if you want. Then move to <strong>Review + create</strong>.</p>
</li>
<li>
<p>Click <strong>Create</strong> to create the AppGW.</p>
</li>
</ol>
<h2><a class="header" href="#create-custom-health-probe" id="create-custom-health-probe">Create custom health probe</a></h2>
<p>When the deployment of the AppGW is completed, if you go to the resource, you would notice that the backend status is unhealthy. That is because the default probe of AppGW doesn't work for APIM. We need to create a custom health probe for it.</p>
<p><img src="images/appgw-default-probe.png" alt="AppGW default probe" /></p>
<ol>
<li>
<p>Click <strong>Health probes</strong> and click <strong>Add</strong> to add a custom health probe. The details of the custom health probe are shown in the diagram below. Note the <strong>Protocol</strong> and host name settings. The <strong>Path</strong> of the APIM probe is <code>/status-0123456789abcdef</code>.</p>
<p><img src="images/appgw-custom-probe.png" alt="AppGW custom probe" /></p>
</li>
<li>
<p>Uncheck <strong>I want to test the backend health before adding the health probe</strong> option and click <strong>Add</strong>.</p>
</li>
<li>
<p>Go to <strong>Backend health</strong> and refresh. The status of the backend should be <strong>Healthy</strong> now.</p>
<p><img src="images/appgw-custom-probe-healthy.png" alt="AppGW healthy probe" /></p>
</li>
</ol>
<h2><a class="header" href="#verify-the-integration" id="verify-the-integration">Verify the integration</a></h2>
<p>We can verify if the integration works by sending a request to the public IP address of the AppGW. We do it with <a href="https://docs.microsoft.com/azure/cloud-shell/overview">Azure Cloud Shell</a> in this tutorial. You can also do it with other tools such as Postman.</p>
<ol>
<li>
<p>In the Azure Portal, open Azure Cloud Shell. Choose <strong>Bash</strong> for the shell.</p>
</li>
<li>
<p>Run the following command with <code>curl</code>. You can find the <a href="https://docs.microsoft.com/azure/api-management/api-management-subscriptions">subscription</a> key of APIM on the <strong>Subscriptions</strong> page of APIM, and the public IP address of AppGW on the <strong>Overview</strong> page of AppGW.</p>
<pre><code class="language-bash">curl -I -H &quot;Ocp-Apim-Subscription-Key: [subscription key]&quot; http://[AppGW public IP]/echo/resource
</code></pre>
</li>
<li>
<p>If everything works, you get <code>HTTP 200 OK</code> in the response.</p>
</li>
</ol>
<p>Now you've integrated the APIM instance with an AppGW. Let's move on to the next tutorial to expand the deployment further with a self-hosted gateway.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../apim/integration-apim-vnet-internal.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../apim/integration-deploy-shgw.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../apim/integration-apim-vnet-internal.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../apim/integration-deploy-shgw.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
